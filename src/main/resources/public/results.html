<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/jpeg" href="poll_logo.jpg">
    <title>Résultats du Sondage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-300 mx-2 min-h-screen flex flex-col items-center justify-start">
     <div id="toaster" class="fixed top-4 right-0 transform z-50 w-full max-w-xs sm:max-w-md px-2"></div>
    <div class="w-full max-w-2xl sm:mt-16 mt-4 bg-white shadow-lg rounded-lg p-4 sm:p-8 mx-2">
        <h1 id="question" class="text-2xl font-bold mb-6 text-center">Résultats en direct...</h1>
        <div id="results-container" class="space-y-4"></div>
        <hr class="my-8">
        <div id="share-links" class="mt-4">
            <h3 class="text-lg font-semibold mb-2 sm:mb-0">Partagez ce sondage !</h3>
            <div class="flex items-center gap-2">
                <p class="bg-gray-100 px-4 py-2 rounded text-xs sm:text-base mb-0">
                    <strong>Lien pour voter :</strong>
                    <a id="vote-link" href="#" class="text-blue-500 underline break-all"></a>
                </p>
                <button id="copy-btn" type="button" class="bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600 transition text-xs sm:text-base">
                    url
                </button>
            </div>
        </div>
        <div>
            <button onclick="window.location.href='index.html'" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition font-bold w-full sm:w-auto">
                Revenir à la création de sondage
            </button>
        </div>
    </div>
    <script>
        function showToast(message, type = "success") {
            const toaster = document.getElementById('toaster');
            const toast = document.createElement('div');
            toast.className = `px-4 py-3 rounded shadow text-black text-lg bg-white mb-2 animate-fade-in text-center text-sm sm:text-base ${type === "success" ? "border-green-500 border-4" : "border-red-500 border-2"}`;
            toast.innerText = message;
            toaster.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        const params = new URLSearchParams(window.location.search);
        const pollId = params.get('id');

        if (!pollId) {
            document.getElementById('question').innerText = "ID de sondage manquant !";
        } else {
            // Lien à partager avec IP locale
            const voteLinkUrl = `http://192.168.1.187:7070/poll.html?id=${pollId}`;
            const voteLink = `http://${window.location.host}/poll.html?id=${pollId}`;
            document.getElementById('vote-link').href = voteLink;
            document.getElementById('vote-link').innerText = voteLink;
            const ws = new WebSocket(`ws://${window.location.host}/results-ws/${pollId}`);

            ws.onmessage = event => {
                const poll = JSON.parse(event.data);
                updateResults(poll);
            };

            ws.onopen = () => console.log('Entrée pour voir les résultats.');
            ws.onclose = () => console.log('Entrée aux résultats perdue.');

            document.getElementById('copy-btn').onclick = function() {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(voteLinkUrl).then(() => {
                        showToast("Lien copié dans le presse-papier !", "success");
                    }).catch(() => {
                        showToast("Erreur lors de la copie du lien.", "error");
                    });
                } else {
                    // Fallback pour vieux navigateurs
                    const tempInput = document.createElement('input');
                    tempInput.value = voteLinkUrl;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    try {
                        document.execCommand('copy');
                        showToast("Lien copié dans le presse-papier !", "success");
                    } catch {
                        showToast("Erreur lors de la copie du lien.", "error");
                    }
                    document.body.removeChild(tempInput);
                }
            };
        }

        function updateResults(poll) {
            document.getElementById('question').innerText = poll.question;
            const container = document.getElementById('results-container');
            container.innerHTML = '';
            const totalVotes = Object.values(poll.votes).reduce((sum, current) => sum + current, 0);

            for (const option in poll.votes) {
                const voteCount = poll.votes[option];
                const percentage = totalVotes === 0 ? 0 : (voteCount / totalVotes) * 100;

                const barContainer = document.createElement('div');
                barContainer.className = 'flex flex-col sm:flex-row items-center gap-2';

                const label = document.createElement('span');
                label.className = 'w-full sm:w-32 font-semibold text-gray-700 text-lg sm:text-base text-center sm:text-left';
                label.innerText = option;

                const bar = document.createElement('div');
                bar.className = 'w-full sm:flex-1 h-8 bg-gray-200 rounded overflow-hidden relative mt-2 sm:mt-0 flex items-center';

                const fill = document.createElement('div');
                fill.className = 'h-8 flex justify-between px-2 font-bold transition-all duration-500 text-xs sm:text-base items-center';
                fill.style.backgroundColor = percentage > 0 ? '#22c55e' : 'transparent';
                fill.style.width = percentage + '%';
                fill.style.minWidth = '80px';

                const votesPercentWrapper = document.createElement('div');
                votesPercentWrapper.className = 'flex flex-row justify-between items-center w-full gap-2';

                // Affichage dynamique : si 0 vote, n'affiche que le pourcentage, texte gris foncé
                if (voteCount === 0) {
                    const percentSpan = document.createElement('span');
                    percentSpan.className = 'text-gray-800';
                    percentSpan.innerText = `(${percentage.toFixed(1)}%)`;
                    votesPercentWrapper.appendChild(percentSpan);
                } else {
                    const voteWord = (voteCount === 1) ? "vote" : "votes";
                    const votesSpan = document.createElement('span');
                    votesSpan.className = 'text-white flex flex-row items-center gap-1';
                    votesSpan.innerText = `${voteCount} ${voteWord}`;

                    const percentSpan = document.createElement('span');
                    percentSpan.className = 'text-white';
                    percentSpan.innerText = `(${percentage.toFixed(1)}%)`;

                    votesPercentWrapper.appendChild(votesSpan);
                    votesPercentWrapper.appendChild(percentSpan);
                }

                fill.appendChild(votesPercentWrapper);
                bar.appendChild(fill);
                barContainer.appendChild(label);
                barContainer.appendChild(bar);

                container.appendChild(barContainer);
            }
        }
    </script>
    <style>
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.5s; }
    </style>
</body>
</html>